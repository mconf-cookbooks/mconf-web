<% if node['apache']['version'] == '2.4' %>
  <% if !node['mconf-web']['with_mconf_home'] %>
Listen 0.0.0.0:80
  <% end %>
  <% if node['mconf-web']['ssl']['enable'] %>
Listen 0.0.0.0:443
  <% end %>
<% end %>

ServerName <%= node['mconf-web']['domain'] %>

<% if node['mconf-web']['ssl']['enable'] %>
<VirtualHost *:443>
<% else %>
<VirtualHost *:80>
<% end %>
  ServerName <%= node['mconf-web']['domain'] %>
  ServerSignature Off

  DocumentRoot <%= node['mconf-web']['deploy_to_full'] %>/public
  <Directory <%= node['mconf-web']['deploy_to_full'] %>/public>
    AllowOverride all
    Options -MultiViews
<% if node['apache']['version'] == '2.4' %>
    Require all granted
<% end %>
  </Directory>

  XSendFile On
  XSendFilePath <%= node['mconf-web']['deploy_to'] %>
  XSendFilePath /tmp

  RewriteEngine On

  # Shows the maintenance page if it exists
  ErrorDocument 503 /system/maintenance.html
  RewriteCond   %{REQUEST_URI} !\.(css|gif|jpg|png)$
  RewriteCond   %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond   %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule   ^.*$  -  [redirect=503,last]

<% if node['mconf-web']['with_mconf_home'] %>
  # Landing page: https://any.org -> http://any.org/
  RewriteRule ^/$ http://%{HTTP_HOST}/ [R,L]
<% end %>

<% if node['mconf-web']['remove_www'] %>
  # Remove www: www.any.org -> any.org
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteRule ^(.*)$ <%= node['mconf-web']['http_protocol'] %>://%1/$1 [R=301,L]
<% end %>

<% if node['mconf-web']['ssl']['enable'] %>
  SSLEngine               on
  SSLCertificateFile      <%= @certificate_file %>
  SSLCertificateKeyFile   <%= @certificate_key_file %>
  <% if @certificate_chain_file %>
  SSLCertificateChainFile <%= @certificate_chain_file %>
  <% end %>
  <% if @ca_certificate_file %>
  SSLCACertificateFile    <%= @ca_certificate_file %>
  <% end %>
  <% if @ca_certificate_path %>
  SSLCACertificatePath    <%= @ca_certificate_path %>
  <% end %>

  # SSL security
  # Includes prevention to POODLE and BEAST
  # See:
  # * https://sslcheck.globalsign.com/en_US/help/acbb2dc6
  # * https://www.linode.com/docs/security/security-patches/disabling-sslv3-for-poodle
  SSLProtocol ALL -SSLv2 -SSLv3
  SSLCipherSuite HIGH:!aNULL:!MD5
  SSLHonorCipherOrder On
  SSLInsecureRenegotiation off

  <% if node['mconf-web']['ssl']['hsts'] %>
  # Enable HTTP Strict Transport Security (HSTS)
  Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains; preload"
  <% end %>

  <% if node['mconf-web']['shibboleth']['enable'] %>
  <LocationMatch "^/secure$">
    AllowOverride all
    AuthType shibboleth
    ShibRequireSession On
    require valid-user
    Order allow,deny
    allow from all
  </LocationMatch>
  <% end %>

  <% if node['mconf-web']['cert_login']['enable'] %>
  # Sign in via certificate
  SSLVerifyClient none
  SSLOptions StrictRequire
  <Location /certificate_login>
    SSLVerifyClient require
    SSLOptions +ExportCertData
    SSLVerifyDepth <%= node['mconf-web']['cert_login']['verify_depth'] %>
  </Location>
  <% end %>
<% end %>

  # debug, info, notice, warn, error, crit, alert, emerg
  LogLevel info
  ErrorLog /var/log/apache2/mconf-web-error.log
  CustomLog /var/log/apache2/mconf-web-access.log combined
<% if node['mconf-web']['ssl']['enable'] && node['mconf-web']['cert_login']['enable'] %>
  CustomLog /var/log/apache2/mconf-web-ssl-request.log "%t %h %{SSL_CLIENT_CERT}x"
<% end %>
</VirtualHost>

<% if node['mconf-web']['ssl']['enable'] && !node['mconf-web']['with_mconf_home'] %>
<VirtualHost *:80>
  RewriteEngine on

  # Simply redirect to the HTTPS site
  RewriteCond %{HTTPS} !=on
  RewriteRule ^(.*) https://%{SERVER_NAME}$1 [R,NE,L]

  # debug, info, notice, warn, error, crit, alert, emerg
  LogLevel debug
  ErrorLog /var/log/apache2/mconf-web-error.log
  CustomLog /var/log/apache2/mconf-web-access.log combined
</VirtualHost>
<% end %>
