<% if node['apache']['version'] == '2.4' %>
  <% if !node['mconf-web']['with_mconf_home'] %>
Listen 0.0.0.0:80
  <% end %>
  <% if node['mconf-web']['ssl']['enable'] %>
Listen 0.0.0.0:443
  <% end %>
<% end %>

ServerName <%= node['mconf-web']['domain'] %>

<% if node['mconf-web']['ssl']['enable'] && !node['mconf-web']['with_mconf_home'] %>
<VirtualHost *:80>
  ServerName <%= node['mconf-web']['domain'] %>
  ServerSignature Off
  Redirect "/" "<%= node['mconf-web']['http_protocol'] %>://<%= node['mconf-web']['domain'] %>/"

  <%= render 'apache-site-log.erb' %>
</VirtualHost>
<% end %>

<VirtualHost *:<%= node['mconf-web']['ssl']['enable'] ? '443' : '80' %>>
  ServerName <%= node['mconf-web']['domain'] %>
  ServerSignature Off

  DocumentRoot <%= node['mconf-web']['deploy_to_full'] %>/public
  <Directory <%= node['mconf-web']['deploy_to_full'] %>/public>
    AllowOverride all
    Options -MultiViews
<% if node['apache']['version'] == '2.4' %>
    Require all granted
<% end %>
<% if node['mconf-web']['max_upload_size'] %>
    LimitRequestBody <%= node['mconf-web']['max_upload_size'] %>
<% end %>
  </Directory>

  XSendFile On
  XSendFilePath <%= node['mconf-web']['deploy_to'] %>
  XSendFilePath /tmp

  RewriteEngine On

  # Shows the maintenance page if it exists
  ErrorDocument 503 /system/maintenance.html
  RewriteCond   %{REQUEST_URI} !\.(css|gif|jpg|png)$
  RewriteCond   %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond   %{SCRIPT_FILENAME} !maintenance.html
  RewriteRule   ^.*$  -  [redirect=503,last]

<% if node['mconf-web']['with_mconf_home'] %>
  # Landing page: https://any.org -> http://any.org/
  RewriteRule ^/$ http://%{HTTP_HOST}/ [R,L]
<% end %>

<% if node['mconf-web']['ssl']['enable'] %>
  <%= render 'apache-site-ssl.erb' %>

  <% if node['mconf-web']['shibboleth']['enable'] %>
  <LocationMatch "^/secure(/associate)?$">
    AllowOverride all
    AuthType shibboleth
    ShibRequireSession On
    require valid-user
    Order allow,deny
    allow from all
  </LocationMatch>
  <% end %>

  <% if node['mconf-web']['cert_login']['enable'] %>
  # Sign in via certificate
  SSLVerifyClient none
  SSLOptions StrictRequire
  <Location /certificate_login>
    SSLVerifyClient require
    SSLOptions +ExportCertData
    SSLVerifyDepth <%= node['mconf-web']['cert_login']['verify_depth'] %>
  </Location>
  <% end %>
<% end %>

  <%= render 'apache-site-log.erb' %>
</VirtualHost>


# Below are the redirects from custom domains to the main domain of this site
<% node['mconf-web']['apache']['domain_redirects'].each do |redir| %>

<VirtualHost *:80>
  ServerName <%= redir %>
  ServerSignature Off
  Redirect "/" "<%= node['mconf-web']['http_protocol'] %>://<%= node['mconf-web']['domain'] %>/"

  <%= render 'apache-site-log.erb' %>
</VirtualHost>

    <% if node['mconf-web']['ssl']['enable'] %>
<VirtualHost *:443>
  ServerName <%= redir %>
  ServerSignature Off
  Redirect "/" "<%= node['mconf-web']['http_protocol'] %>://<%= node['mconf-web']['domain'] %>/"

  <%= render 'apache-site-ssl.erb' %>
  <%= render 'apache-site-log.erb' %>
</VirtualHost>
    <% end %>

<% end %>
